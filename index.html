<?php
session_start();
if (!isset($_SESSION['csrf_token'])) {
    $_SESSION['csrf_token'] = bin2hex(random_bytes(32));
}
?>
<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport"
    content="width=device-width, height=device-height, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>2048 é¢åŒ…ç‰ˆ</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#f59563',
            secondary: '#8f7a66',
            background: '#faf8ef',
            grid: '#bbada0',
            cell: 'rgba(238, 228, 218, 0.35)',
          },
          fontFamily: {
            game: ['Arial', 'sans-serif'],
          },
        },
      }
    }
  </script>
  <style type="text/tailwindcss">
    @layer utilities {
      .content-auto {
        content-visibility: auto;
      }
      .game-title {
        @apply text-[clamp(2rem,5vw,3rem)] font-bold text-secondary mb-4;
      }
      .game-button {
        @apply bg-primary hover:bg-primary/90 text-white font-semibold py-2 px-4 rounded-lg transition-all duration-200;
      }
      .grid-container {
        @apply relative bg-grid rounded-xl p-2 my-4;
      }
      .grid-cell {
        @apply bg-cell rounded-lg absolute transition-all duration-150;
      }
      .number-cell {
        @apply absolute rounded-lg text-center font-bold transition-all duration-200 flex items-center justify-center;
      }
      .score-text {
        @apply text-secondary text-lg mb-2;
      }
      .leaderboard-container {
        @apply fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-white rounded-xl p-6 shadow-xl z-50 max-w-xs w-full hidden;
      }
      .leaderboard-list {
        @apply list-decimal list-inside max-h-60 overflow-y-auto pr-2;
      }
      .name-popup {
        @apply fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-white rounded-xl p-6 shadow-xl z-50 max-w-xs w-full hidden;
      }
      .close-button {
        @apply absolute top-3 right-3 text-gray-500 hover:text-gray-700 cursor-pointer;
      }
    }
  </style>
  <script>
    // æ¸¸æˆçŠ¶æ€
    let gameState = {
      grid: null,
      score: 0,
      bestScore: 0,
      gameOver: false,
      canMove: true,
      csrfToken: <?php echo json_encode($_SESSION['csrf_token']); ?>
    };
    
    // DOM å…ƒç´ 
    const elements = {
      gridContainer: document.getElementById('grid-container'),
      scoreDisplay: document.getElementById('score'),
      positionDisplay: document.getElementById('position'),
      leaderboard: document.getElementById('leaderboard'),
      leaderboardList: document.getElementById('leaderboard-list'),
      namePopup: document.getElementById('name-popup'),
      playerNameInput: document.getElementById('playerNameInput')
    };
    
    // é˜²æ­¢é¡µé¢æ»‘åŠ¨
    document.addEventListener('touchmove', function(e) {
        if (!gameState.canMove) {
            e.preventDefault();
        }
    }, { passive: false });
    
    // é¡µé¢åŠ è½½ååˆå§‹åŒ–æ¸¸æˆ
    window.addEventListener('load', function() {
      initGame();
      renderGrid();
      generateRandomTile();
      generateRandomTile();
    });
    
    // åˆå§‹åŒ–æ¸¸æˆç½‘æ ¼
    function initGame() {
      gameState.grid = createEmptyGrid();
      gameState.score = 0;
      gameState.gameOver = false;
      updateScoreDisplay();
    }
    
    // åˆ›å»ºç©ºç½‘æ ¼
    function createEmptyGrid() {
      return Array(4).fill().map(() => Array(4).fill(0));
    }
    
    // æ¸²æŸ“ç½‘æ ¼
    function renderGrid() {
      elements.gridContainer.innerHTML = '';
      
      // åˆ›å»ºç½‘æ ¼å•å…ƒæ ¼
      for (let i = 0; i < 4; i++) {
        for (let j = 0; j < 4; j++) {
          // åˆ›å»ºèƒŒæ™¯å•å…ƒæ ¼
          const gridCell = document.createElement('div');
          gridCell.className = 'grid-cell';
          gridCell.style.width = '70px';
          gridCell.style.height = '70px';
          gridCell.style.left = `${j * 78}px`;
          gridCell.style.top = `${i * 78}px`;
          elements.gridContainer.appendChild(gridCell);
          
          // åˆ›å»ºæ•°å­—å•å…ƒæ ¼
          const numberCell = document.createElement('div');
          numberCell.className = 'number-cell';
          numberCell.id = `tile-${i}-${j}`;
          numberCell.style.width = '70px';
          numberCell.style.height = '70px';
          numberCell.style.left = `${j * 78}px`;
          numberCell.style.top = `${i * 78}px`;
          
          const value = gameState.grid[i][j];
          if (value > 0) {
            numberCell.textContent = value;
            numberCell.className = `number-cell bg-number-${value} text-number-${value}`;
          }
          
          elements.gridContainer.appendChild(numberCell);
        }
      }
      
      // è®¾ç½®ç½‘æ ¼å®¹å™¨å¤§å°
      elements.gridContainer.style.width = '312px';
      elements.gridContainer.style.height = '312px';
    }
    
    // ç”Ÿæˆéšæœºæ–¹å—
    function generateRandomTile() {
      if (!hasEmptyCell()) return;
      
      let emptyCells = [];
      for (let i = 0; i < 4; i++) {
        for (let j = 0; j < 4; j++) {
          if (gameState.grid[i][j] === 0) {
            emptyCells.push({i, j});
          }
        }
      }
      
      const cell = emptyCells[Math.floor(Math.random() * emptyCells.length)];
      const value = Math.random() < 0.9 ? 2 : 4;
      
      gameState.grid[cell.i][cell.j] = value;
      renderTile(cell.i, cell.j, value);
      
      // æ£€æŸ¥æ¸¸æˆæ˜¯å¦ç»“æŸ
      if (!canMove()) {
        gameState.gameOver = true;
        setTimeout(gameOver, 500);
      }
    }
    
    // æ¸²æŸ“æ–¹å—åŠ¨ç”»
    function renderTile(i, j, value) {
      const tile = document.getElementById(`tile-${i}-${j}`);
      tile.textContent = value;
      tile.className = `number-cell bg-number-${value} text-number-${value} scale-0 opacity-0`;
      
      // è§¦å‘é‡æ’åæ·»åŠ åŠ¨ç”»ç±»
      setTimeout(() => {
        tile.classList.remove('scale-0', 'opacity-0');
        tile.classList.add('scale-100', 'opacity-100', 'transition-all', 'duration-200');
      }, 10);
    }
    
    // æ›´æ–°åˆ†æ•°æ˜¾ç¤º
    function updateScoreDisplay() {
      elements.scoreDisplay.textContent = gameState.score;
      
      // æ ¹æ®åˆ†æ•°æ›´æ–°ç­‰çº§æ˜¾ç¤º
      let position = 'æŒ‘æˆ˜';
      if (gameState.score >= 1000) position = 'å¤§å¸ˆ';
      else if (gameState.score >= 500) position = 'ç²¾è‹±';
      else if (gameState.score >= 200) position = 'é«˜æ‰‹';
      else if (gameState.score >= 100) position = 'ç†Ÿæ‰‹';
      
      elements.positionDisplay.textContent = position;
    }
    
    // æ¸¸æˆç»“æŸå¤„ç†
    function gameOver() {
      if (gameState.gameOver) {
        gameState.canMove = true;
        elements.namePopup.classList.remove('hidden');
        elements.playerNameInput.focus();
      }
    }
    
    // æäº¤ç©å®¶å§“åå’Œåˆ†æ•°
    function submitPlayerName() {
      const name = elements.playerNameInput.value.trim() || "åŒ¿åç©å®¶";
      
      // ç®€å•éªŒè¯
      if (name.length > 20) {
        alert("æ˜µç§°é•¿åº¦ä¸èƒ½è¶…è¿‡20ä¸ªå­—ç¬¦");
        return;
      }
      
      saveToLeaderboard(name, gameState.score, gameState.csrfToken);
      elements.namePopup.classList.add('hidden');
    }
    
    // ä¿å­˜åˆ†æ•°åˆ°æ’è¡Œæ¦œ
    function saveToLeaderboard(name, score, csrfToken) {
      fetch('./leaderboard.php?action=add', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: `name=${encodeURIComponent(name)}&score=${score}&csrf_token=${csrfToken}`
      })
      .then(response => {
        if (!response.ok) {
          throw new Error('ç½‘ç»œå“åº”é”™è¯¯');
        }
        return response.text();
      })
      .then(data => {
        console.log('æ’è¡Œæ¦œæäº¤æˆåŠŸ:', data);
        renderLeaderboard();
      })
      .catch(error => {
        console.error('æ’è¡Œæ¦œæäº¤å¤±è´¥:', error);
        alert('æäº¤åˆ†æ•°å¤±è´¥ï¼Œè¯·ç¨åå†è¯•');
      });
    }
    
    // æ¸²æŸ“æ’è¡Œæ¦œ
    function renderLeaderboard() {
      fetch('./leaderboard.php?action=get')
        .then(response => {
          if (!response.ok) {
            throw new Error('ç½‘ç»œå“åº”é”™è¯¯');
          }
          return response.json();
        })
        .then(data => {
          elements.leaderboardList.innerHTML = '';
          
          if (data.length === 0) {
            elements.leaderboardList.innerHTML = '<li class="text-gray-500">æš‚æ— è®°å½•</li>';
          } else {
            data.forEach((entry, index) => {
              const li = document.createElement('li');
              li.className = 'py-2 border-b border-gray-100 last:border-0';
              li.innerHTML = `
                <span class="font-semibold text-primary">${index + 1}.</span> 
                <span class="ml-2">${entry.name}</span>
                <span class="float-right font-semibold">${entry.score} åˆ†</span>
              `;
              elements.leaderboardList.appendChild(li);
            });
          }
          
          elements.leaderboard.classList.remove('hidden');
        })
        .catch(error => {
          console.error('åŠ è½½æ’è¡Œæ¦œå¤±è´¥:', error);
          elements.leaderboardList.innerHTML = '<li class="text-red-500">åŠ è½½æ’è¡Œæ¦œå¤±è´¥</li>';
          elements.leaderboard.classList.remove('hidden');
        });
    }
    
    // åˆ‡æ¢æ’è¡Œæ¦œæ˜¾ç¤º
    function toggleLeaderboard() {
      elements.leaderboard.classList.toggle('hidden');
      if (!elements.leaderboard.classList.contains('hidden')) {
        renderLeaderboard();
      }
    }
    
    // æ–°æ¸¸æˆ
    function newGame() {
      elements.leaderboard.classList.add('hidden');
      elements.namePopup.classList.add('hidden');
      initGame();
      renderGrid();
      generateRandomTile();
      generateRandomTile();
      gameState.canMove = false;
    }
    
    // æ£€æŸ¥æ˜¯å¦æœ‰ç©ºå•å…ƒæ ¼
    function hasEmptyCell() {
      for (let i = 0; i < 4; i++) {
        for (let j = 0; j < 4; j++) {
          if (gameState.grid[i][j] === 0) {
            return true;
          }
        }
      }
      return false;
    }
    
    // æ£€æŸ¥æ˜¯å¦å¯ä»¥ç§»åŠ¨
    function canMove() {
      // æ£€æŸ¥æ˜¯å¦æœ‰ç©ºå•å…ƒæ ¼
      if (hasEmptyCell()) return true;
      
      // æ£€æŸ¥ç›¸é‚»å•å…ƒæ ¼æ˜¯å¦å¯ä»¥åˆå¹¶
      for (let i = 0; i < 4; i++) {
        for (let j = 0; j < 4; j++) {
          const value = gameState.grid[i][j];
          if (value !== 0) {
            // æ£€æŸ¥å³ä¾§
            if (j < 3 && gameState.grid[i][j+1] === value) return true;
            // æ£€æŸ¥ä¸‹æ–¹
            if (i < 3 && gameState.grid[i+1][j] === value) return true;
          }
        }
      }
      
      return false;
    }
    
    // é”®ç›˜æ§åˆ¶
    document.addEventListener('keydown', function(event) {
      if (gameState.gameOver || !gameState.canMove) return;
      
      switch (event.key) {
        case 'ArrowUp':
          moveUp();
          break;
        case 'ArrowDown':
          moveDown();
          break;
        case 'ArrowLeft':
          moveLeft();
          break;
        case 'ArrowRight':
          moveRight();
          break;
      }
    });
    
    // è§¦æ‘¸æ§åˆ¶
    let touchStartX = 0;
    let touchStartY = 0;
    
    document.addEventListener('touchstart', function(event) {
      touchStartX = event.touches[0].clientX;
      touchStartY = event.touches[0].clientY;
    }, false);
    
    document.addEventListener('touchend', function(event) {
      if (gameState.gameOver || !gameState.canMove) return;
      
      const touchEndX = event.changedTouches[0].clientX;
      const touchEndY = event.changedTouches[0].clientY;
      
      const diffX = touchEndX - touchStartX;
      const diffY = touchEndY - touchStartY;
      
      // åˆ¤æ–­æ»‘åŠ¨æ–¹å‘
      if (Math.abs(diffX) > Math.abs(diffY)) {
        // æ°´å¹³æ»‘åŠ¨
        if (diffX > 50) {
          moveRight();
        } else if (diffX < -50) {
          moveLeft();
        }
      } else {
        // å‚ç›´æ»‘åŠ¨
        if (diffY > 50) {
          moveDown();
        } else if (diffY < -50) {
          moveUp();
        }
      }
    }, false);
    
    // ç§»åŠ¨å‡½æ•°å®ç°ï¼ˆç®€åŒ–ç‰ˆï¼‰
    function moveUp() {
      // å®é™…æ¸¸æˆé€»è¾‘å®ç°
      gameState.canMove = false;
      setTimeout(() => {
        gameState.canMove = true;
        generateRandomTile();
      }, 200);
    }
    
    function moveDown() {
      // å®é™…æ¸¸æˆé€»è¾‘å®ç°
      gameState.canMove = false;
      setTimeout(() => {
        gameState.canMove = true;
        generateRandomTile();
      }, 200);
    }
    
    function moveLeft() {
      // å®é™…æ¸¸æˆé€»è¾‘å®ç°
      gameState.canMove = false;
      setTimeout(() => {
        gameState.canMove = true;
        generateRandomTile();
      }, 200);
    }
    
    function moveRight() {
      // å®é™…æ¸¸æˆé€»è¾‘å®ç°
      gameState.canMove = false;
      setTimeout(() => {
        gameState.canMove = true;
        generateRandomTile();
      }, 200);
    }
  </script>
</head>
<body class="bg-background font-game min-h-screen flex flex-col items-center justify-center">
  <div class="container max-w-md mx-auto px-4 py-8">
    <h1 class="game-title text-center">2048 é¢åŒ…ç‰ˆ</h1>
    
    <div class="flex justify-center mb-4">
      <button class="game-button" onclick="newGame()">
        <i class="fa fa-refresh mr-2"></i>å†æ¥ä¸€å±€
      </button>
    </div>
    
    <p class="score-text text-center">
      ä½ çš„è¶…è¯ç­‰çº§æ˜¯ <span id="position" class="font-bold">æŒ‘æˆ˜</span> â€” ç»éªŒå€¼: 
      <span id="score" class="font-bold">0</span> ç‚¹
    </p>
    
    <div id="grid-container" class="grid-container mx-auto"></div>
    
    <div class="flex justify-center mt-6">
      <button class="game-button" onclick="toggleLeaderboard()">
        <i class="fa fa-trophy mr-2"></i>æ’è¡Œæ¦œ
      </button>
    </div>
  </div>
  
  <!-- æ’è¡Œæ¦œæ¨¡æ€æ¡† -->
  <div id="leaderboard" class="leaderboard-container">
    <span class="close-button" onclick="toggleLeaderboard()">
      <i class="fa fa-times"></i>
    </span>
    <h3 class="text-xl font-bold text-center mb-4">ğŸ† æ’è¡Œæ¦œ</h3>
    <ol id="leaderboard-list" class="leaderboard-list"></ol>
    <button class="game-button w-full mt-4" onclick="toggleLeaderboard()">
      å…³é—­
    </button>
  </div>
  
  <!-- æ¸¸æˆç»“æŸè¾“å…¥æ˜µç§°å¼¹çª— -->
  <div id="name-popup" class="name-popup">
    <span class="close-button" onclick="elements.namePopup.classList.add('hidden')">
      <i class="fa fa-times"></i>
    </span>
    <h3 class="text-xl font-bold text-center mb-4">æ¸¸æˆç»“æŸï¼</h3>
    <p class="mb-4 text-center">ä½ çš„åˆ†æ•°æ˜¯: <span class="font-bold" id="final-score">0</span></p>
    <p class="mb-3">è¯·è¾“å…¥ä½ çš„æ˜µç§°ï¼š</p>
    <input type="text" id="playerNameInput" placeholder="ç©å®¶æ˜µç§°" 
           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary" />
    <button onclick="submitPlayerName()" class="game-button w-full mt-4">
      æäº¤æˆç»©
    </button>
  </div>
  
  <footer class="mt-auto mb-4 text-center text-gray-500 text-sm">
    <p>
      <a href="https://beian.miit.gov.cn/#/Integrated/index" target="_blank" class="hover:underline">èµ£ICPå¤‡2025063750å·-1</a>
    </p>
  </footer>
</body>
</html>
</body>
</html>
