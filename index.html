<?php
session_start();
if (!isset($_SESSION['csrf_token'])) {
    $_SESSION['csrf_token'] = bin2hex(random_bytes(32));
}
?>
<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport"
    content="width=device-width, height=device-height, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>2048 面包版</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#f59563',
            secondary: '#8f7a66',
            background: '#faf8ef',
            grid: '#bbada0',
            cell: 'rgba(238, 228, 218, 0.35)',
          },
          fontFamily: {
            game: ['Arial', 'sans-serif'],
          },
        },
      }
    }
  </script>
  <style type="text/tailwindcss">
    @layer utilities {
      .content-auto {
        content-visibility: auto;
      }
      .game-title {
        @apply text-[clamp(2rem,5vw,3rem)] font-bold text-secondary mb-4;
      }
      .game-button {
        @apply bg-primary hover:bg-primary/90 text-white font-semibold py-2 px-4 rounded-lg transition-all duration-200;
      }
      .grid-container {
        @apply relative bg-grid rounded-xl p-2 my-4;
      }
      .grid-cell {
        @apply bg-cell rounded-lg absolute transition-all duration-150;
      }
      .number-cell {
        @apply absolute rounded-lg text-center font-bold transition-all duration-200 flex items-center justify-center;
      }
      .score-text {
        @apply text-secondary text-lg mb-2;
      }
      .leaderboard-container {
        @apply fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-white rounded-xl p-6 shadow-xl z-50 max-w-xs w-full hidden;
      }
      .leaderboard-list {
        @apply list-decimal list-inside max-h-60 overflow-y-auto pr-2;
      }
      .name-popup {
        @apply fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-white rounded-xl p-6 shadow-xl z-50 max-w-xs w-full hidden;
      }
      .close-button {
        @apply absolute top-3 right-3 text-gray-500 hover:text-gray-700 cursor-pointer;
      }
    }
  </style>
  <script>
    // 游戏状态
    let gameState = {
      grid: null,
      score: 0,
      bestScore: 0,
      gameOver: false,
      canMove: true,
      csrfToken: <?php echo json_encode($_SESSION['csrf_token']); ?>
    };
    
    // DOM 元素
    const elements = {
      gridContainer: document.getElementById('grid-container'),
      scoreDisplay: document.getElementById('score'),
      positionDisplay: document.getElementById('position'),
      leaderboard: document.getElementById('leaderboard'),
      leaderboardList: document.getElementById('leaderboard-list'),
      namePopup: document.getElementById('name-popup'),
      playerNameInput: document.getElementById('playerNameInput')
    };
    
    // 防止页面滑动
    document.addEventListener('touchmove', function(e) {
        if (!gameState.canMove) {
            e.preventDefault();
        }
    }, { passive: false });
    
    // 页面加载后初始化游戏
    window.addEventListener('load', function() {
      initGame();
      renderGrid();
      generateRandomTile();
      generateRandomTile();
    });
    
    // 初始化游戏网格
    function initGame() {
      gameState.grid = createEmptyGrid();
      gameState.score = 0;
      gameState.gameOver = false;
      updateScoreDisplay();
    }
    
    // 创建空网格
    function createEmptyGrid() {
      return Array(4).fill().map(() => Array(4).fill(0));
    }
    
    // 渲染网格
    function renderGrid() {
      elements.gridContainer.innerHTML = '';
      
      // 创建网格单元格
      for (let i = 0; i < 4; i++) {
        for (let j = 0; j < 4; j++) {
          // 创建背景单元格
          const gridCell = document.createElement('div');
          gridCell.className = 'grid-cell';
          gridCell.style.width = '70px';
          gridCell.style.height = '70px';
          gridCell.style.left = `${j * 78}px`;
          gridCell.style.top = `${i * 78}px`;
          elements.gridContainer.appendChild(gridCell);
          
          // 创建数字单元格
          const numberCell = document.createElement('div');
          numberCell.className = 'number-cell';
          numberCell.id = `tile-${i}-${j}`;
          numberCell.style.width = '70px';
          numberCell.style.height = '70px';
          numberCell.style.left = `${j * 78}px`;
          numberCell.style.top = `${i * 78}px`;
          
          const value = gameState.grid[i][j];
          if (value > 0) {
            numberCell.textContent = value;
            numberCell.className = `number-cell bg-number-${value} text-number-${value}`;
          }
          
          elements.gridContainer.appendChild(numberCell);
        }
      }
      
      // 设置网格容器大小
      elements.gridContainer.style.width = '312px';
      elements.gridContainer.style.height = '312px';
    }
    
    // 生成随机方块
    function generateRandomTile() {
      if (!hasEmptyCell()) return;
      
      let emptyCells = [];
      for (let i = 0; i < 4; i++) {
        for (let j = 0; j < 4; j++) {
          if (gameState.grid[i][j] === 0) {
            emptyCells.push({i, j});
          }
        }
      }
      
      const cell = emptyCells[Math.floor(Math.random() * emptyCells.length)];
      const value = Math.random() < 0.9 ? 2 : 4;
      
      gameState.grid[cell.i][cell.j] = value;
      renderTile(cell.i, cell.j, value);
      
      // 检查游戏是否结束
      if (!canMove()) {
        gameState.gameOver = true;
        setTimeout(gameOver, 500);
      }
    }
    
    // 渲染方块动画
    function renderTile(i, j, value) {
      const tile = document.getElementById(`tile-${i}-${j}`);
      tile.textContent = value;
      tile.className = `number-cell bg-number-${value} text-number-${value} scale-0 opacity-0`;
      
      // 触发重排后添加动画类
      setTimeout(() => {
        tile.classList.remove('scale-0', 'opacity-0');
        tile.classList.add('scale-100', 'opacity-100', 'transition-all', 'duration-200');
      }, 10);
    }
    
    // 更新分数显示
    function updateScoreDisplay() {
      elements.scoreDisplay.textContent = gameState.score;
      
      // 根据分数更新等级显示
      let position = '挑战';
      if (gameState.score >= 1000) position = '大师';
      else if (gameState.score >= 500) position = '精英';
      else if (gameState.score >= 200) position = '高手';
      else if (gameState.score >= 100) position = '熟手';
      
      elements.positionDisplay.textContent = position;
    }
    
    // 游戏结束处理
    function gameOver() {
      if (gameState.gameOver) {
        gameState.canMove = true;
        elements.namePopup.classList.remove('hidden');
        elements.playerNameInput.focus();
      }
    }
    
    // 提交玩家姓名和分数
    function submitPlayerName() {
      const name = elements.playerNameInput.value.trim() || "匿名玩家";
      
      // 简单验证
      if (name.length > 20) {
        alert("昵称长度不能超过20个字符");
        return;
      }
      
      saveToLeaderboard(name, gameState.score, gameState.csrfToken);
      elements.namePopup.classList.add('hidden');
    }
    
    // 保存分数到排行榜
    function saveToLeaderboard(name, score, csrfToken) {
      fetch('./leaderboard.php?action=add', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: `name=${encodeURIComponent(name)}&score=${score}&csrf_token=${csrfToken}`
      })
      .then(response => {
        if (!response.ok) {
          throw new Error('网络响应错误');
        }
        return response.text();
      })
      .then(data => {
        console.log('排行榜提交成功:', data);
        renderLeaderboard();
      })
      .catch(error => {
        console.error('排行榜提交失败:', error);
        alert('提交分数失败，请稍后再试');
      });
    }
    
    // 渲染排行榜
    function renderLeaderboard() {
      fetch('./leaderboard.php?action=get')
        .then(response => {
          if (!response.ok) {
            throw new Error('网络响应错误');
          }
          return response.json();
        })
        .then(data => {
          elements.leaderboardList.innerHTML = '';
          
          if (data.length === 0) {
            elements.leaderboardList.innerHTML = '<li class="text-gray-500">暂无记录</li>';
          } else {
            data.forEach((entry, index) => {
              const li = document.createElement('li');
              li.className = 'py-2 border-b border-gray-100 last:border-0';
              li.innerHTML = `
                <span class="font-semibold text-primary">${index + 1}.</span> 
                <span class="ml-2">${entry.name}</span>
                <span class="float-right font-semibold">${entry.score} 分</span>
              `;
              elements.leaderboardList.appendChild(li);
            });
          }
          
          elements.leaderboard.classList.remove('hidden');
        })
        .catch(error => {
          console.error('加载排行榜失败:', error);
          elements.leaderboardList.innerHTML = '<li class="text-red-500">加载排行榜失败</li>';
          elements.leaderboard.classList.remove('hidden');
        });
    }
    
    // 切换排行榜显示
    function toggleLeaderboard() {
      elements.leaderboard.classList.toggle('hidden');
      if (!elements.leaderboard.classList.contains('hidden')) {
        renderLeaderboard();
      }
    }
    
    // 新游戏
    function newGame() {
      elements.leaderboard.classList.add('hidden');
      elements.namePopup.classList.add('hidden');
      initGame();
      renderGrid();
      generateRandomTile();
      generateRandomTile();
      gameState.canMove = false;
    }
    
    // 检查是否有空单元格
    function hasEmptyCell() {
      for (let i = 0; i < 4; i++) {
        for (let j = 0; j < 4; j++) {
          if (gameState.grid[i][j] === 0) {
            return true;
          }
        }
      }
      return false;
    }
    
    // 检查是否可以移动
    function canMove() {
      // 检查是否有空单元格
      if (hasEmptyCell()) return true;
      
      // 检查相邻单元格是否可以合并
      for (let i = 0; i < 4; i++) {
        for (let j = 0; j < 4; j++) {
          const value = gameState.grid[i][j];
          if (value !== 0) {
            // 检查右侧
            if (j < 3 && gameState.grid[i][j+1] === value) return true;
            // 检查下方
            if (i < 3 && gameState.grid[i+1][j] === value) return true;
          }
        }
      }
      
      return false;
    }
    
    // 键盘控制
    document.addEventListener('keydown', function(event) {
      if (gameState.gameOver || !gameState.canMove) return;
      
      switch (event.key) {
        case 'ArrowUp':
          moveUp();
          break;
        case 'ArrowDown':
          moveDown();
          break;
        case 'ArrowLeft':
          moveLeft();
          break;
        case 'ArrowRight':
          moveRight();
          break;
      }
    });
    
    // 触摸控制
    let touchStartX = 0;
    let touchStartY = 0;
    
    document.addEventListener('touchstart', function(event) {
      touchStartX = event.touches[0].clientX;
      touchStartY = event.touches[0].clientY;
    }, false);
    
    document.addEventListener('touchend', function(event) {
      if (gameState.gameOver || !gameState.canMove) return;
      
      const touchEndX = event.changedTouches[0].clientX;
      const touchEndY = event.changedTouches[0].clientY;
      
      const diffX = touchEndX - touchStartX;
      const diffY = touchEndY - touchStartY;
      
      // 判断滑动方向
      if (Math.abs(diffX) > Math.abs(diffY)) {
        // 水平滑动
        if (diffX > 50) {
          moveRight();
        } else if (diffX < -50) {
          moveLeft();
        }
      } else {
        // 垂直滑动
        if (diffY > 50) {
          moveDown();
        } else if (diffY < -50) {
          moveUp();
        }
      }
    }, false);
    
    // 移动函数实现（简化版）
    function moveUp() {
      // 实际游戏逻辑实现
      gameState.canMove = false;
      setTimeout(() => {
        gameState.canMove = true;
        generateRandomTile();
      }, 200);
    }
    
    function moveDown() {
      // 实际游戏逻辑实现
      gameState.canMove = false;
      setTimeout(() => {
        gameState.canMove = true;
        generateRandomTile();
      }, 200);
    }
    
    function moveLeft() {
      // 实际游戏逻辑实现
      gameState.canMove = false;
      setTimeout(() => {
        gameState.canMove = true;
        generateRandomTile();
      }, 200);
    }
    
    function moveRight() {
      // 实际游戏逻辑实现
      gameState.canMove = false;
      setTimeout(() => {
        gameState.canMove = true;
        generateRandomTile();
      }, 200);
    }
  </script>
</head>
<body class="bg-background font-game min-h-screen flex flex-col items-center justify-center">
  <div class="container max-w-md mx-auto px-4 py-8">
    <h1 class="game-title text-center">2048 面包版</h1>
    
    <div class="flex justify-center mb-4">
      <button class="game-button" onclick="newGame()">
        <i class="fa fa-refresh mr-2"></i>再来一局
      </button>
    </div>
    
    <p class="score-text text-center">
      你的超话等级是 <span id="position" class="font-bold">挑战</span> — 经验值: 
      <span id="score" class="font-bold">0</span> 点
    </p>
    
    <div id="grid-container" class="grid-container mx-auto"></div>
    
    <div class="flex justify-center mt-6">
      <button class="game-button" onclick="toggleLeaderboard()">
        <i class="fa fa-trophy mr-2"></i>排行榜
      </button>
    </div>
  </div>
  
  <!-- 排行榜模态框 -->
  <div id="leaderboard" class="leaderboard-container">
    <span class="close-button" onclick="toggleLeaderboard()">
      <i class="fa fa-times"></i>
    </span>
    <h3 class="text-xl font-bold text-center mb-4">🏆 排行榜</h3>
    <ol id="leaderboard-list" class="leaderboard-list"></ol>
    <button class="game-button w-full mt-4" onclick="toggleLeaderboard()">
      关闭
    </button>
  </div>
  
  <!-- 游戏结束输入昵称弹窗 -->
  <div id="name-popup" class="name-popup">
    <span class="close-button" onclick="elements.namePopup.classList.add('hidden')">
      <i class="fa fa-times"></i>
    </span>
    <h3 class="text-xl font-bold text-center mb-4">游戏结束！</h3>
    <p class="mb-4 text-center">你的分数是: <span class="font-bold" id="final-score">0</span></p>
    <p class="mb-3">请输入你的昵称：</p>
    <input type="text" id="playerNameInput" placeholder="玩家昵称" 
           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary" />
    <button onclick="submitPlayerName()" class="game-button w-full mt-4">
      提交成绩
    </button>
  </div>
  
  <footer class="mt-auto mb-4 text-center text-gray-500 text-sm">
    <p>
      <a href="https://beian.miit.gov.cn/#/Integrated/index" target="_blank" class="hover:underline">赣ICP备2025063750号-1</a>
    </p>
  </footer>
</body>
</html>
</body>
</html>
